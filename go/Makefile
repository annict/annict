.PHONY: help
help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

.PHONY: run
run: ## ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
	APP_ENV=dev op run --env-file=".env" -- go run cmd/server/main.go

.PHONY: templ-generate
templ-generate: ## templãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰Goã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã€importæ–‡ã‚’æ•´ç†
	@which templ > /dev/null || (echo "Installing templ from go.mod..." && go install github.com/a-h/templ/cmd/templ)
	templ generate
	@$(MAKE) goimports

.PHONY: goimports
goimports: ## goimportsã§importæ–‡ã‚’æ•´ç†
	@which goimports > /dev/null || (echo "Installing goimports from go.mod..." && go install golang.org/x/tools/cmd/goimports)
	goimports -w .

.PHONY: goimports-check
goimports-check: ## goimportsã§importæ–‡ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå·®åˆ†ãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼ï¼‰
	@which goimports > /dev/null || (echo "Installing goimports from go.mod..." && go install golang.org/x/tools/cmd/goimports)
	@unformatted=$$(goimports -l .); \
	if [ -n "$$unformatted" ]; then \
		echo "The following files have incorrect imports:"; \
		echo "$$unformatted"; \
		echo ""; \
		echo "Please run 'make goimports' to fix imports"; \
		exit 1; \
	fi

.PHONY: build
build: templ-generate ## ãƒã‚¤ãƒŠãƒªã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆtempl-generateãŒgoimportsã‚‚å®Ÿè¡Œï¼‰
	go build -o bin/server cmd/server/main.go

.PHONY: test
test: db-setup-test ## ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@if [ "$$CI" = "true" ]; then \
		echo "CIç’°å¢ƒ: çŸ­æ™‚é–“ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ (-short)"; \
		go test -v -race -short ./...; \
	else \
		echo "ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"; \
		APP_ENV=test op run --env-file=".env" -- go test -v -race ./...; \
	fi

.PHONY: test-pkg
test-pkg: db-setup-test ## ç‰¹å®šã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆä½¿ç”¨ä¾‹: make test-pkg PKG=internal/handler/password_resetï¼‰
	@if [ -z "$(PKG)" ]; then \
		echo "ã‚¨ãƒ©ãƒ¼: PKGå¤‰æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"; \
		echo "ä½¿ç”¨ä¾‹: make test-pkg PKG=internal/handler/password_reset"; \
		exit 1; \
	fi
	@echo "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ $(PKG) ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@APP_ENV=test op run --env-file=".env" -- go test -v -race ./$(PKG)

.PHONY: test-run
test-run: db-setup-test ## ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆä½¿ç”¨ä¾‹: make test-run PKG=internal/handler/password_reset RUN=TestCreate_TurnstileVerificationï¼‰
	@if [ -z "$(PKG)" ]; then \
		echo "ã‚¨ãƒ©ãƒ¼: PKGå¤‰æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"; \
		echo "ä½¿ç”¨ä¾‹: make test-run PKG=internal/handler/password_reset RUN=TestCreate_TurnstileVerification"; \
		exit 1; \
	fi
	@if [ -z "$(RUN)" ]; then \
		echo "ã‚¨ãƒ©ãƒ¼: RUNå¤‰æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"; \
		echo "ä½¿ç”¨ä¾‹: make test-run PKG=internal/handler/password_reset RUN=TestCreate_TurnstileVerification"; \
		exit 1; \
	fi
	@echo "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ $(PKG) ã®ãƒ†ã‚¹ãƒˆ $(RUN) ã‚’å®Ÿè¡Œ"
	@APP_ENV=test op run --env-file=".env" -- go test -v -race ./$(PKG) -run $(RUN)

.PHONY: test-verbose
test-verbose: db-setup-test ## è©³ç´°ãƒ­ã‚°ä»˜ãã§å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
	@echo "ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: è©³ç´°ãƒ­ã‚°ä»˜ãã§å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@APP_ENV=test op run --env-file=".env" -- go test -v -race -count=1 ./...

.PHONY: fmt
fmt: ## ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
	go fmt ./...
	@$(MAKE) goimports

.PHONY: lint-golangci
lint-golangci: ## golangci-lintã‚’å®Ÿè¡Œ
	@echo "ğŸ” golangci-lintã‚’å®Ÿè¡Œä¸­..."
	@golangci-lint run --config=.golangci.yml ./...

.PHONY: lint
lint: lint-golangci ## ãƒªãƒ³ãƒˆã‚’å®Ÿè¡Œï¼ˆgolangci-lintã‚’ä½¿ç”¨ï¼‰

.PHONY: clean
clean: ## ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³
	rm -rf bin/
	find . -name "*_templ.go" -type f -delete

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰
.PHONY: db-migrate
db-migrate: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
	APP_ENV=dev op run --env-file=".env" -- dbmate up
	# PostgreSQL 17.6ã®pg_dumpãŒç”Ÿæˆã™ã‚‹ãƒ©ãƒ³ãƒ€ãƒ ãª\restrictè¡Œã‚’å‰Šé™¤
	# https://github.com/amacneil/dbmate/issues/678
	@sed -i '/^\\restrict /d;/^\\unrestrict /d' db/schema.sql

.PHONY: db-setup-test
db-setup-test: ## ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
	@if [ "$$CI" = "true" ]; then \
		echo "CIç’°å¢ƒ: ãƒ†ã‚¹ãƒˆDBã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚¹ã‚­ãƒ¼ãƒã‚’é©ç”¨"; \
		psql -h localhost -U postgres -d annict_test -c 'DROP SCHEMA public CASCADE; CREATE SCHEMA public;' > /dev/null 2>&1; \
		psql -h localhost -U postgres -d annict_test -f db/schema.sql > /dev/null; \
	else \
		echo "ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: ãƒ†ã‚¹ãƒˆDBã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚¹ã‚­ãƒ¼ãƒã‚’é©ç”¨"; \
		psql -h postgresql -U postgres -d annict_test -c 'DROP SCHEMA public CASCADE; CREATE SCHEMA public;' > /dev/null 2>&1; \
		psql -h postgresql -U postgres -d annict_test -f db/schema.sql > /dev/null; \
	fi

.PHONY: db-migrate-test
db-migrate-test: ## ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œï¼ˆéæ¨å¥¨ã€db-setup-testã‚’ä½¿ç”¨ï¼‰
	@echo "è­¦å‘Š: db-migrate-testã¯éæ¨å¥¨ã§ã™ã€‚ä»£ã‚ã‚Šã«db-setup-testã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"
	@make db-setup-test

.PHONY: db-rollback
db-rollback: ## æœ€å¾Œã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
	APP_ENV=dev op run --env-file=".env" -- dbmate down

.PHONY: db-new
db-new: ## æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆä½¿ç”¨æ³•: make db-new name=create_usersï¼‰
	dbmate new $(name)

.PHONY: db-dump
db-dump: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’db/schema.sqlã«ãƒ€ãƒ³ãƒ—
	APP_ENV=dev op run --env-file=".env" -- dbmate dump
	# PostgreSQL 17.6ã®pg_dumpãŒç”Ÿæˆã™ã‚‹ãƒ©ãƒ³ãƒ€ãƒ ãª\restrictè¡Œã‚’å‰Šé™¤
	# https://github.com/amacneil/dbmate/issues/678
	@sed -i '/^\\restrict /d;/^\\unrestrict /d' db/schema.sql

.PHONY: sqlc-generate
sqlc-generate: ## SQLã‚¯ã‚¨ãƒªã‹ã‚‰Goã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
	sqlc generate

.PHONY: seed
seed: ## é–‹ç™ºç’°å¢ƒç”¨ã®ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
	@echo "ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™..."
	APP_ENV=dev op run --env-file=".env" -- go run cmd/seed/main.go
