name: Go CI

on:
  push:
    paths:
      - "go/**"
      - ".github/workflows/go-ci.yml"

env:
  GO_VERSION: "1.25.1"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: go
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check templ generate
        run: |
          # templãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰Goã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã€ã‚³ãƒŸãƒƒãƒˆå¿˜ã‚ŒãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
          make templ-generate
          make goimports
          git diff --exit-code internal/templates/

      - name: Check go mod tidy
        run: |
          # ä¾å­˜é–¢ä¿‚ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯: ä¸è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã€å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ 
          go mod tidy
          # go.mod/go.sumãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆtidyã—å¿˜ã‚Œã‚’æ¤œå‡ºï¼‰
          git diff --exit-code go.mod go.sum

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9.1.0
        with:
          version: v2.6.2
          working-directory: go
          args: --config=.golangci.yml ./...

  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: go
    env:
      APP_ENV: test
      DATABASE_URL: postgres://postgres@localhost:5432/annict_test?sslmode=disable
      ANNICT_REDIS_URL: redis://localhost:16379/1
      ANNICT_PORT: "4004"
      ANNICT_DOMAIN: "test.example.com"
      ANNICT_COOKIE_DOMAIN: ".test.example.com"
      ANNICT_SESSION_SECURE: "false"
      ANNICT_SESSION_HTTPONLY: "true"
      ANNICT_S3_BUCKET_NAME: "annict-test"
      ANNICT_IMGPROXY_ENDPOINT: "http://localhost:8080"
      ANNICT_IMGPROXY_KEY: "test_key"
      ANNICT_IMGPROXY_SALT: "test_salt"
      ANNICT_RAILS_APP_URL: "http://localhost:3000"
      ANNICT_DISABLE_RATE_LIMIT: "false"
      ANNICT_RESEND_FROM_EMAIL: "test@example.com"

    services:
      postgresql:
        image: postgres:17.5
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: annict_test
          POSTGRES_HOST_AUTH_METHOD: trust
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:8.2.3-alpine
        ports:
          - 16379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get dependencies
        run: |
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          go mod download

      - name: Setup test database
        run: |
          # ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å®Œå…¨ãªã‚¹ã‚­ãƒ¼ãƒã‚’é©ç”¨ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¨åŒã˜æ–¹æ³•ï¼‰
          # æ³¨: db/schema.sqlã¯æœ€æ–°ã®å®Œå…¨ãªã‚¹ã‚­ãƒ¼ãƒã‚’å«ã‚€ï¼ˆmake db-dumpã§ç”Ÿæˆï¼‰
          make db-setup-test

      - name: Run tests
        shell: bash
        env:
          CI: true
        run: |
          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ï¼‰
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­ï¼ˆCIç’°å¢ƒ: çŸ­æ™‚é–“ãƒ†ã‚¹ãƒˆã®ã¿ï¼‰..."
          echo ""

          # ã‚¨ãƒ©ãƒ¼ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åœæ­¢ã—ãªã„
          set +e
          make test 2>&1 | tee test-output.log
          test_exit_code=$?
          set -e

          # ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ $test_exit_code -ne 0 ]; then
            echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            echo ""

            # å¤±æ•—ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            echo "ğŸ“¦ å¤±æ•—ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:"
            grep "^FAIL" test-output.log | sed 's/^/  /' || echo "  (å¤±æ•—ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)"

            echo ""
            echo "ğŸ” å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®è©³ç´°:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®è©³ç´°ã‚’æŠ½å‡ºï¼ˆ--- FAIL: ã§å§‹ã¾ã‚‹è¡Œã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
            grep -A 2 -- "--- FAIL:" test-output.log | grep -E -- "(--- FAIL:|\.go:[0-9]+:)" || echo "  (å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®è©³ç´°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)"

            exit $test_exit_code
          else
            echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"
            # æˆåŠŸã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ•°ã‚’è¡¨ç¤º
            ok_count=$(grep -c "^ok" test-output.log || echo "0")
            echo "   åˆè¨ˆ ${ok_count} ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ"
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: go
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build
        run: |
          # ãƒã‚¤ãƒŠãƒªã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆtempl generateã‚‚è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
          make build

      - name: Check binary exists
        run: |
          # ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¦ãƒã‚¤ãƒŠãƒªãŒç”Ÿæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
          if [ ! -f bin/server ]; then
            echo "Build failed: binary not found"
            exit 1
          fi
