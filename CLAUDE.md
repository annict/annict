# Annict 開発ガイド

このファイルは、Claude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

## プロジェクト概要

Annict はアニメ視聴記録サービスです。
ユーザーは自分が見たアニメに対して「見てる」や「見たい」といったステータスが設定できたり、
見たアニメの感想を書いてあとから振り返ることができます。

## モノレポ構造

このリポジトリは、Go 版と Rails 版の 2 つのサブプロジェクトをモノレポとして管理しています：

```
/workspace/
├── go/          # Go版の実装（段階的に機能を移行中）
├── rails/       # Rails版の実装（既存の本番システム）
├── .github/     # 共通のCI/CD設定
└── CLAUDE.md    # このファイル（プロジェクト全体のガイド）
```

各サブプロジェクトには独自の CLAUDE.md ファイルがあり、それぞれの技術スタック、開発環境、コーディング規約などが記載されています：

- **Go 版**: `go/CLAUDE.md` - Go 版固有の開発ガイド
- **Rails 版**: `rails/CLAUDE.md` - Rails 版固有の開発ガイド

## Rails から Go への移行について

現在、既存の Rails 実装の Annict を Go で段階的に再実装するプロジェクトが進行中です。

### 移行の基本方針

- **既存 DB をそのまま使用**: Rails 側で管理されている PostgreSQL データベースを共有
- **段階的移行**: Rails と Go が同一の DB とセッションストアを共有し、段階的に機能を移行
- **データマイグレーション不要**: DB スキーマは既存のものを使用し、データ移行は行わない
- **共通インフラの継続利用**: 画像配信（Cloudflare R2 + imgproxy）などの共通インフラは Go 版移行後も継続して使用

### Rails 側のソースコード

Rails 版のソースコードは `/workspace/rails/` 配下に格納されています：

```
/workspace/rails/
├── app/controllers/     # コントローラー
├── app/models/          # モデル
├── app/views/           # ビューテンプレート
├── config/routes.rb     # ルーティング定義
└── db/structure.sql     # DBスキーマ
```

Go 版を実装する際は、Rails 版のコードを参考にすることで既存の仕様を理解できます。

## 共通インフラ

### データベース（PostgreSQL）

- **バージョン**: PostgreSQL 17.3
- **共有方針**: Rails 版と Go 版で同一のデータベースを共有
- **開発環境**: Docker Compose で管理
  - Rails 版用: `host.docker.internal:15432`
  - Go 版テスト用: `postgresql:5432`

### セッションストア（PostgreSQL）

- **ストレージ**: PostgreSQL の `sessions` テーブルを使用
- **Rails 版**: ActiveRecord SessionStore を使用
  - 各リクエストで `updated_at` カラムを自動更新
  - セッションの有効期限: 30 日
- **Go 版**: 同じ `sessions` テーブルを共有
  - 認証ミドルウェアで `updated_at` カラムを更新
  - Rails 版と完全に互換性のあるセッション管理を実現
- **セッションクリーンアップ**: 毎日 19:00 に `rake session:sweep` タスクが実行され、30 日以上前のセッションを自動削除
- **共有方針**: Rails 版と Go 版で同一のセッションストアを共有（段階的移行を実現）

### 画像配信アーキテクチャ

作品画像の配信には以下のシステムを使用しています（Rails 版と Go 版で共通利用）：

#### S3 互換オブジェクトストレージ（Cloudflare R2）

- **開発環境**: Cloudflare R2（開発環境用アカウント）
- **本番環境**: Cloudflare R2（本番環境用アカウント）
- **バケット名**:
  - 開発: `annict-development`
  - 本番: `annict-production`
- **画像パス**: `shrine/`プレフィックス付きで保存（Rails の Shrine ライブラリの仕様）
- **アクセスキー**: `.env.development.local`（開発）、環境変数（本番）に設定

#### imgproxy（画像リサイズ・最適化プロキシ）

- **ポート**: 18080（開発環境）
- **アクセス方法**: S3 プロトコル経由でストレージにアクセス（`s3://annict-{environment}/shrine/{path}`）
- **セキュリティ**: 署名付き URL を生成してセキュアな画像配信を実現
- **設定**: KEY/SALT は環境変数で管理
- **管理**: Docker Compose（`/workspace/rails/docker-compose.yml`）で管理

#### 画像 URL 生成の流れ

1. `work_images`テーブルの`image_data`カラム（JSON）から画像パスを取得
2. S3 プロトコルの URL を生成（例: `s3://annict-development/shrine/workimage/...`）
3. imgproxy の署名付き URL を生成（HMAC による署名）
4. ブラウザは imgproxy 経由で最適化された画像を取得

**重要**: S3 互換ストレージと imgproxy は Rails 版と Go 版で共通利用するため、Go 版が本流になっても継続して使用します。

## 開発環境のセットアップ

### 前提条件

- Docker 及び Docker Compose がインストール済み
- Dev Container を使用した開発環境

### セットアップ手順

1. **リポジトリのクローン**

```sh
git clone <repository-url>
cd annict
```

2. **Dev Container の起動**

VS Code や Claude Code などでリポジトリを開くと、Dev Container が自動的に起動します。

3. **共通インフラの起動（ホスト側で実行）**

Rails 版の Docker Compose で共通インフラ（PostgreSQL、imgproxy）を起動します：

```sh
cd rails
docker compose up -d
```

4. **各サブプロジェクトのセットアップ**

各サブプロジェクトの詳細なセットアップ手順は、それぞれの CLAUDE.md ファイルを参照してください：

- Go 版: `go/CLAUDE.md`の「開発環境のセットアップ」セクション
- Rails 版: `rails/CLAUDE.md`の「開発環境のセットアップ」セクション

### 環境変数の設定

各サブプロジェクトで`.env`ファイルを作成し、必要な環境変数を設定します。詳細は各サブプロジェクトの CLAUDE.md を参照してください。

## サブプロジェクトのドキュメント

各サブプロジェクトの詳細なドキュメントは以下を参照してください：

- **Go 版**: @go/CLAUDE.md - Go 版の技術スタック、プロジェクト構造、コーディング規約、テスト戦略など
- **Rails 版**: @rails/CLAUDE.md - Rails 版の技術スタック、プロジェクト構造、コーディング規約、テスト戦略など

## 開発ワークフロー

### コミット前のチェック

各サブプロジェクトで実装を行った場合は、コミット前に以下を確認してください：

- コードフォーマット（Go: `make fmt`、Rails: `bundle exec rubocop -A`）
- リント（Go: `make lint`、Rails: `bundle exec rubocop`）
- テスト（Go: `ANNICT_ENV=test make test`、Rails: `bundle exec rspec`）

### コメントのガイドライン

このガイドラインは Go 版と Rails 版の両方に適用されます。

**良いコメント**：

- コードの**意図や理由**を説明する（「なぜこうしたか」）
- 将来の開発者が理解できる、文脈に依存しない内容
- 複雑なロジックや、一見不自然に見える実装の背景を説明する

**避けるべきコメント**：

- ❌ **実装の変遷を説明するコメント**（「以前は〜だった」「〜は削除した」など）
- ❌ **過去との比較**（「別途インストール不要になった」「〜を統合したため不要」など）
- ❌ **自明なことの説明**（コードを読めばわかること）
- ❌ **やり取りの文脈に依存するコメント**（PR レビューのコメントは PR に書く）

**原則**：

- **コメントはコードの「なぜ」を説明し、「何を」はコードに語らせる**
- git の履歴に残る情報（過去の実装、変更の経緯）はコメントに書かない
- レビューコメントや議論の文脈に依存する内容は書かない

詳細な例については、各サブプロジェクトの CLAUDE.md を参照してください：

- Go 版: `go/CLAUDE.md` の「コメントのガイドライン」セクション
- Rails 版: `rails/CLAUDE.md` の「コメントのガイドライン」セクション

### Pull Request のガイドライン

Pull Request を作成する際は、以下のルールを遵守してください：

#### サイズの制限

- **変更ファイル数**: 20 ファイル以下
- **実装コードの行数**: 300 行以下を目安（追加・削除行の合計）
- **テストコードの行数**: 制限なし（必要な分だけ追加して OK）

#### 実装とテストのセット化

- **必須**: 実装コードとそのテストコードは同じ PR に含める
- 新機能や修正を行う場合は、必ず対応するテストを追加・更新する
- テストがない実装は原則としてマージしない
- **テストは品質保証のために必要な分だけ書く**: 行数を気にせず、正常系・異常系・境界値などを網羅する

#### PR を小さく保つ理由

- レビュアーの負担を軽減し、レビューの質を向上させる
- バグの混入リスクを最小化する
- 問題が発生した場合のロールバックを容易にする
- CI/CD パイプラインの実行時間を短縮する

#### 大きな変更が必要な場合

機能が大きくなる場合は、以下のように分割してください：

1. **段階的な実装**: 機能を複数のステップに分割し、それぞれ独立した PR として作成
2. **リファクタリングの分離**: リファクタリングと新機能追加を別々の PR に分ける

#### 例外

以下の場合は制限を超えることが許容されます：

- 自動生成されたファイル（マイグレーション、スキーマなど）
- 広範囲に影響する命名変更やリファクタリング
- ただし、これらの場合でも可能な限り分割を検討してください

#### 重要な原則

**品質優先**: 上記の行数制限はあくまで**目安**です。以下の点を優先してください：

- **テストの完全性**: 実装にはテストを必ず含める。行数制限のためにテストを省略しない
- **コードの完全性**: 機能を中途半端な状態で分割しない。動作する最小単位で PR を作成する
- **可読性**: 無理に行数を減らすためにコードの可読性を犠牲にしない

行数制限を超えても、以下を満たしていれば問題ありません：

- 実装コードとテストコードの両方が含まれている
- コードレビューが可能な範囲（目安: 1 ファイルあたり 500 行以下）
- PR の目的が明確で、1 つの機能や修正に集中している

**判断基準**: 「行数を守ること」よりも「きちんと実装すること」を優先してください。

## CI/CD

このモノレポの CI/CD 設定は`.github/workflows/`ディレクトリに配置されています：

- `go-ci.yml`: Go 版の CI（lint、test、build）
- `rails-ci.yml`: Rails 版の CI（zeitwerk、sorbet、standard、erb_lint、eslint、rspec）

各 CI は対応するファイルが変更されたときのみ実行されます（パスフィルタリング）。

## トラブルシューティング

### データベース接続エラー

- PostgreSQL コンテナが起動しているか確認: `docker compose ps`
- ポートが正しいか確認: Rails 版開発用は 15432、Go 版テスト用は 5432

### 画像が表示されない

- imgproxy コンテナが起動しているか確認
- 環境変数（R2 アクセスキー、imgproxy KEY/SALT）が正しく設定されているか確認
- Cloudflare R2 バケットへのアクセス権限が正しく設定されているか確認

### その他の問題

各サブプロジェクト固有の問題については、それぞれの CLAUDE.md の「トラブルシューティング」セクションを参照してください。
